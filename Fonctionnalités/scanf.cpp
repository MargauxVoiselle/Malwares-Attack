#include "stdafx.h"
#include <windows.h> 
#include <stdio.h>
#include <wincrypt.h>
#define ENCRYPT_ALGORITHM CALG_AES_128

HCRYPTPROV hCryptProv;
HCRYPTKEY * hKeyPtr = (HCRYPTKEY *) malloc(sizeof(HCRYPTKEY));

void encrypt();
void decrypt();

char * input = (char *) malloc(32*sizeof(char));
DWORD length;
DWORD initialLength;

int _tmain(int argc, _TCHAR* argv[])
{
	printf("Input?\n");
	scanf("%32s", input);
	printf("%s\n", input);

	length = strlen(input);
	initialLength = strlen(input);

	if (CryptAcquireContext(
        &hCryptProv,
        NULL,
        NULL,
        PROV_RSA_AES,
        0))
    {
        printf("A cryptographic provider has been acquired. \n");
    }
    else
    {
        printf("Error during CryptAcquireContext!\n");
        exit(1);
    }
	
	// Encrypt the input
	encrypt();

	printf("Encrypted Text: %s\n", input);

    // Decrypt the encrypted input
    decrypt();

	printf("Decrypted Text: %.*s\n", initialLength, input);

	while(1);
	return 0;
}

void encrypt(){
	//DWORD oldPermissions;
	//VirtualProtect(hKeyPtr, 100, PAGE_EXECUTE_READWRITE, &oldPermissions);


	if(CryptGenKey(
		hCryptProv, 
        ENCRYPT_ALGORITHM, 
        CRYPT_EXPORTABLE,
        hKeyPtr))
	{
		printf("A session key has been created.\n");
	} 
	else
	{
		printf("Error during CryptGenKey.\n"); 
        exit(1);
	}

	printf("PlainText: %s\n",input);
    printf("Buf Len: %d\n",length);

	if (!CryptEncrypt(*hKeyPtr,
		NULL, 
        1,  
        0, 
        (BYTE *) input, 
        &length,
        32)) {   
		printf("Encryption failed\n");
		exit(1);
	}
}

void decrypt()
{
    if (!CryptDecrypt(*hKeyPtr,
        NULL,
        1,
        0,
        (BYTE *) input,
        &length))
    {
        printf("Decryption failed\n");
        exit(1);
    }
}