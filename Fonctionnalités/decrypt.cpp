#include "stdafx.h"
#include <windows.h> 
#include <stdio.h>
#include <wincrypt.h>
#define ENCRYPT_ALGORITHM CALG_AES_128

int _tmain(int argc, _TCHAR* argv[])
{
    HCRYPTPROV hCryptProv;
    HCRYPTKEY hKey;

    //---------------------------------------------------------------
    // Get the handle to the provider.
    if(CryptAcquireContext(
        &hCryptProv, 
        NULL, 
        NULL, //MS_ENH_RSA_AES_PROV
        PROV_RSA_AES, 
        0))
    {
        printf("A cryptographic provider has been acquired. \n");
    }
    else
    {
        printf("Error during CryptAcquireContext!\n");
        exit(1);
    }

    //---------------------------------------------------------------
    // Assume that you have the encrypted message in text_test.
    char text_test[] = "encrypted_message"; // Replace with the actual encrypted message.
    DWORD text_len = strlen(text_test);
    printf("CipherText: %s\n", text_test);
    printf("Len: %d\n", text_len);

    //---------------------------------------------------------------
    // Create a random session key. 
    if(CryptGenKey(
        hCryptProv, 
        ENCRYPT_ALGORITHM, 
        CRYPT_EXPORTABLE, 
        &hKey))
    {
        printf("A session key has been created.\n");
    } 
    else
    {
        printf("Error during CryptGenKey.\n"); 
        exit(1);
    }

    //---------------------------------------------------------------
    // Decrypt the message.
    if (!CryptDecrypt(hKey,
        NULL,  // hHash = no hash
        1,  // Final
        0,     // dwFlags
        (BYTE *) &text_test,
        &text_len)) {
        printf("Decryption failed\n");
    }

    printf("PlainText: %s\n", text_test);
    printf("Len: %d\n", text_len);

    CryptDestroyKey(hKey);
    CryptReleaseContext(hCryptProv, 0);

    return 0;
}
