#include "stdafx.h"
#include <Windows.h>


int _tmain(int argc, _TCHAR* argv[]){
	HANDLE notepad;
	int PID;
	printf("PID? ");
	// évite de devoir partir du nom de l'exécutable, plus fastidieux
	scanf("%d", &PID);

	// accès à Notepad
	notepad = OpenProcess(PROCESS_ALL_ACCESS, FALSE, PID);
	char *buffer = "c:\\documents and settings\\administrateur\\mes documents\\visual studio 2010\\Projects\\Payload\\Release\\Payload.dll"; 
	// malloc dans le processus de Notepad, VirtualAllocEx nécessite les droits pour débugguer (axe d'amélioration)
	char *buffer_notepad = (char *) VirtualAllocEx(notepad, NULL, strlen(buffer)+1, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
	SIZE_T N;
	WriteProcessMemory(notepad, buffer_notepad, buffer, strlen(buffer)+1, &N);

	void *loadLibrary = (void *) LoadLibraryA;
	// demande à Notepad de lancer la fonction loadLibrary avec l'argument buffer_notepad
	CreateRemoteThread(notepad, NULL, 0, (LPTHREAD_START_ROUTINE) loadLibrary, buffer_notepad, 0, NULL);
	
	printf("Done");
	while(1);
	return 0;
}

