// dllmain.cpp : Définit le point d'entrée pour l'application DLL.
#include "stdafx.h"

char * create_file_w;

__declspec(naked) void payload(){
	// enregistrement des registres dans la pile
	__asm{
		pushad
	}
	// ce qui sert de payload
	MessageBoxA(0, L"world!", L"Hello", MB_OK);
	__asm{
		popad
	}
	// récupération des registres avant le payload
	_asm{
		mov edi, edi
		push ebp
		mov ebp, esp
		sub esp, 0x58
	}__asm{
		mov eax, [create_file_w]
		add eax, 8
		push eax
		ret
	}
}

BOOL APIENTRY DllMain( HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved){
	switch (ul_reason_for_call)
	{
	case DLL_PROCESS_ATTACH:
		create_file_w = (char *) CreateFileW;
		DWORD old;
		VirtualProtect(create_file_w, 6, PAGE_EXECUTE_READWRITE, &old);
		create_file_w[0] = '\x68';
		create_file_w[5] = '\xc3';
		((unsigned int *) (create_file_w+1))[0] = (unsigned int) payload;

	case DLL_THREAD_ATTACH:
	case DLL_THREAD_DETACH:
	case DLL_PROCESS_DETACH:
		break;
	}
	return TRUE;
}

